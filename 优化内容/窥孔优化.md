# 窥孔优化

## 基本块内窥孔

### 1.冗余load，store

![](https://raw.githubusercontent.com/yuwensq/imgBase/master/202303082200925.jpg)

这里第二条指令可以不要。至少可以把ldr替换成一条mov指令，也可以快一点。

### 2.没有必要的mov指令

常见于对数组的初始化等过程中。

![](https://raw.githubusercontent.com/yuwensq/imgBase/master/202303082205426.jpg)

可以把mov r10,r9给删了，把add指令的目标操作数设成r10.

![](https://raw.githubusercontent.com/yuwensq/imgBase/master/202303082301605.jpg)

类似的。

### 3.无用的mov<sub>cond</sub>指令

![](https://raw.githubusercontent.com/yuwensq/imgBase/master/202303082208092.jpg)

这种情况的产生是由于有时候条件比较的结果会作为其他条件比较的操作数，因此会使用mov<sub>cond</sub>指令来生成条件比较的结果，但是有些时候会造成冗余，删除即可。

### 4.不可达代码

![](https://raw.githubusercontent.com/yuwensq/imgBase/master/202303082213326.jpg)

一个基本块中，出现在无条件跳转指令后且的代码可以删除。如上方的bx lr; b .L31;可以把b .L31删除。<font color=red>注意，这种情况，我们如果删除b .L31，最后有可能会出现L31基本块没有前驱的局面，这个时候我们可以把L31基本块删除掉。可能实现也比较简单，记录每个基本块的前驱个数，少一个前驱减一，减至零可以把该块删除？(这个在中间代码就可以好像，到时候尽管都加一下)</font>

### 5.使用乘加指令

![](https://raw.githubusercontent.com/yuwensq/imgBase/master/202303082231301.jpg)

上图这样的指令可以替换为一条乘加指令，[参考](https://mcu.eetrend.com/blog/2018/100010873.html)

### 6.乘除法使用移位操作

![](https://raw.githubusercontent.com/yuwensq/imgBase/master/202303082239715.jpg)

除以2，可以用右移代替。

### 7.和2有点像的冗余mov指令

![](https://raw.githubusercontent.com/yuwensq/imgBase/master/202303082258104.jpg)

常见于存储函数返回值，可以直接str r0, addr.

## 基本块间窥孔

### 1.只有一条无条件跳转的基本块

![](https://raw.githubusercontent.com/yuwensq/imgBase/master/202303082211412.jpg)

可以把这个基本块删除了，减少一次跳转。



